name: Docker Image CI

on:
	push:
		branches:
			- main

jobs:
	build:
		runs-on: ubuntu-latest

		steps:
		- name: Checkout
			uses: actions/checkout@v3

		- name: Configure AWS credentials
			uses: aws-actions/configure-aws-credentials@v1
			with:
				aws-access-key-id: ${{ secrets.ACCESS_KEY }}
				aws-secret-access-key: ${{ secrets.SECRET_KEY }}
				aws-region: eu-west-2

		- name: Login to Amazon ECR
			id: login-ecr
			uses: aws-actions/amazon-ecr-login@v1

		- name: Build, tag, and push the image to Amazon ECR
			id: build-image
			env:
				ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
				ECR_REPOSITORY: ${{ secrets.REPO_NAME }}
				IMAGE_TAG: ${{ github.sha }}
			run: |
				# Build a docker container and push it to ECR 
				docker build -t stoogoff --build-arg db_user=${{ secrets.DB_USER }} --build-arg db_password=${{ secrets.DB_PASSWORD }} .
				docker tag stoogoff:latest $ECR_REGISTRY/$ECR_REPOSITORY:latest
				docker tag stoogoff:latest $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
				docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
				docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
